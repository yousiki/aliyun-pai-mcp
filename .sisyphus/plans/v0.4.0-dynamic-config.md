# v0.4.0 — Dynamic Config, Profiles, & Agent Workflow Paradigm

## TL;DR

> **Quick Summary**: Evolve aliyun-pai-mcp from static settings to dynamic, agent-controllable configuration. Agents can understand config schema, modify job resources (GPU/image/pods), switch profiles (debug vs train), and follow a guided workflow paradigm — all through MCP tools with user approval.
> 
> **Deliverables**:
> - ConfigStore class (mutable settings with validation + persistence + locked field enforcement)
> - 6 new MCP tools: `pai_config_schema`, `pai_config_update`, `pai_config_list_profiles`, `pai_config_apply_profile`, `pai_config_create_profile`, `pai_help`
> - Server `instructions` with workflow paradigm + security rules
> - Remove codesource tools, deprecate `codeCommit`
> - Updated schema with profiles support, version bump to 0.4.0
> 
> **Estimated Effort**: Medium-Large (7 tasks, ~2-3 days)
> **Parallel Execution**: YES — 2 waves after foundation
> **Critical Path**: Task 1 → Task 2 → Task 3 → Tasks 4,5,6 (parallel) → Task 7

---

## Context

### Original Request
User wants v0.4.0 to let AI agents flexibly create jobs with different resource configurations (1 GPU debug vs 8 GPU training) by understanding and modifying MCP config at runtime. Also wants to embed a recommended workflow paradigm and security rules into the MCP server.

### Interview Summary
**Key Discussions**:
- **Dynamic Config**: Agent should see config schema with descriptions/constraints, request field-level changes (with user approval via destructiveHint)
- **Config Profiles**: Agent can apply predefined profiles (debug/train) and create new ones
- **Code Source Simplification**: Remove `pai_codesource_update` (Aliyun API unreliable), deprecate `codeCommit` (buggy), keep only `codeBranch`
- **Workflow Paradigm**: Code → push → select profile → submit → logs → iterate. Embedded via `instructions` + `pai_help` tool
- **Security Prompts**: Agent MUST only use pai_* tools, never direct API/curl/credential access
- **Transport/Credentials**: Unchanged in v0.4.0 (stdio, settings.json)
- **OpenCode Permission**: Recommend `external_directory: deny` in docs

**Research Findings**:
- MCP SDK `instructions` goes in **second argument**: `new McpServer({ name, version }, { instructions: "..." })`
- `JobSpecSchema` is `z.record(z.string(), z.unknown())` — no Zod reflection possible, must hardcode schema descriptions
- `pai_codesource_update` does NOT exist in codebase (only `pai_codesource_get`) — deletion scope is just `_get`
- OpenCode supports granular permission config with `external_directory` and per-tool rules
- `destructiveHint` is advisory only — clients MAY prompt, not MUST

### Metis Review
**Identified Gaps** (addressed in plan):
- `instructions` must be in McpServer second arg, not first (corrected in Task 5)
- `pai_codesource_update` doesn't exist — only delete `pai_codesource_get` (corrected in Task 3)
- `profiles` field must be optional in schema for v0.3.0→v0.4.0 migration (handled in Task 1)
- `JobSpecSchema` is untyped `z.record` — `pai_config_schema` must hardcode field descriptions (handled in Task 4)
- Only 3 of 9 existing tools actually read mutable fields, but all should use ConfigStore for DI consistency (handled in Task 2)
- Version appears in 3 places: `package.json`, `src/index.ts`, `src/mcp/server.ts` (handled in Task 7)
- `codeCommit` should be deprecated in description, NOT removed (handled in Task 3)

---

## Work Objectives

### Core Objective
Transform the MCP server from static, admin-configured job settings to an agent-interactive system where AI agents can understand, inspect, and modify job resource configuration through MCP tools, guided by an embedded workflow paradigm.

### Concrete Deliverables
- `src/config/store.ts` — ConfigStore class
- `src/mcp/tools/config-schema.ts` — pai_config_schema tool
- `src/mcp/tools/config-update.ts` — pai_config_update tool
- `src/mcp/tools/config-profiles.ts` — pai_config_list/apply/create_profile tools
- `src/mcp/tools/help.ts` — pai_help tool
- Modified: `src/config/schema.ts` — profiles field, profile schema
- Modified: `src/mcp/server.ts` — instructions, ConfigStore wiring
- Modified: all 7 remaining tool files — ConfigStore DI
- Modified: `src/mcp/tools/job-submit.ts` — deprecate codeCommit
- Deleted: `src/mcp/tools/codesource.ts`
- Modified: `README.md` — updated workflow, OpenCode permission guide
- Modified: `AGENTS.md`, `src/mcp/tools/AGENTS.md` — updated tool list

### Definition of Done
- [ ] `bun run typecheck` passes (exit 0)
- [ ] `bun run check` passes (Biome, exit 0)
- [ ] Version "0.4.0" in exactly 3 files (package.json, index.ts, server.ts)
- [ ] 13 MCP tools registered (7 existing - 1 deleted + 6 new = 12... wait: 9 - 2 + 6 = 13? Let me recount: 9 original - 1 codesource_get deleted = 8, + 6 new = 14. But pai_config is existing and stays. So: whoami, config, job-list, job-get, job-submit, job-stop, job-logs, job-wait = 8 remaining + config-schema, config-update, config-list-profiles, config-apply-profile, config-create-profile, help = 6 new → **14 total**)
- [ ] `pai_config` output contains no `accessKeySecret` or `securityToken`
- [ ] Settings with `profiles: undefined` loads without error (v0.3.0 compat)

### Must Have
- ConfigStore with locked field enforcement (throws on attempt to modify locked fields)
- Agent can view full config schema with field descriptions and constraints
- Agent can update modifiable fields (jobSpecs, image, mounts, jobType, maxRunningJobs)
- Agent can list, apply, and create config profiles
- Server instructions contain workflow paradigm + security rules
- `pai_help` tool returns detailed usage guide
- `codeCommit` deprecated (not removed) in `pai_job_submit`
- `pai_codesource_get` removed

### Must NOT Have (Guardrails)
- ❌ Config history/undo/rollback system
- ❌ Profile import/export features
- ❌ Generic Zod-to-description reflection engine (hardcode known field descriptions)
- ❌ Dynamic DLC/STS client recreation (credentials/region locked, clients created once)
- ❌ Config change notifications via MCP resource subscriptions
- ❌ Remote API validation of config values (Zod-only local validation)
- ❌ Network calls from `pai_help` (static embedded text only)
- ❌ Removal of `codeCommit` parameter (deprecate in description only)
- ❌ `destructiveHint` treated as security enforcement (it's advisory UX only)

---

## Verification Strategy

> **UNIVERSAL RULE: ZERO HUMAN INTERVENTION**
>
> ALL tasks verified by running commands. No "user manually tests" criteria.

### Test Decision
- **Infrastructure exists**: NO (project has no test framework)
- **Automated tests**: NO (quality via TypeScript strict + Biome + Zod runtime validation, matching project conventions)
- **Framework**: N/A

### Agent-Executed QA Scenarios (MANDATORY — ALL tasks)

Every task includes verification via `bun run typecheck`, `bun run check`, and specific functional checks.

**Verification Tool by Deliverable Type:**

| Type | Tool | How Agent Verifies |
|------|------|-------------------|
| TypeScript modules | Bash (`bun run typecheck`) | Strict type checking, no errors |
| Code style | Bash (`bun run check`) | Biome format + lint pass |
| MCP server startup | Bash (`bun run src/index.ts server`) | Process starts without crash |
| Tool output | Bash (pipe JSON-RPC to stdin) | Parse response, assert fields |

---

## Execution Strategy

### Parallel Execution Waves

```
Wave 1 (Foundation — Sequential):
├── Task 1: ConfigStore class + Schema changes
└── Task 2: DI refactor (settings → configStore) across all tools

Wave 2 (Features — Parallel after Wave 2):
├── Task 3: Remove codesource + deprecate codeCommit
├── Task 4: pai_config_schema + pai_config_update tools
├── Task 5: Server instructions + pai_help tool
└── Task 6: Config profile tools

Wave 3 (Finalize):
└── Task 7: Version bump, docs, AGENTS.md update

Critical Path: Task 1 → Task 2 → Task 4 → Task 7
Parallel Speedup: ~30% faster than sequential
```

### Dependency Matrix

| Task | Depends On | Blocks | Can Parallelize With |
|------|------------|--------|---------------------|
| 1 | None | 2, 3, 4, 5, 6 | None |
| 2 | 1 | 3, 4, 5, 6 | None |
| 3 | 2 | 7 | 4, 5, 6 |
| 4 | 2 | 7 | 3, 5, 6 |
| 5 | 2 | 7 | 3, 4, 6 |
| 6 | 2 | 7 | 3, 4, 5 |
| 7 | 3, 4, 5, 6 | None | None (final) |

### Agent Dispatch Summary

| Wave | Tasks | Recommended Dispatch |
|------|-------|---------------------|
| 1 | 1, 2 | Sequential, single agent (foundation work) |
| 2 | 3, 4, 5, 6 | Parallel — 4 independent agents |
| 3 | 7 | Single agent (finalization) |

---

## TODOs

- [x] 1. ConfigStore Class + Schema Changes

  **What to do**:

  Create `src/config/store.ts` — a ConfigStore class that:
  - Wraps a mutable `Settings` object
  - Provides `get()` to read current settings (returns deep clone, never the internal reference)
  - Provides `update(changes)` to modify settings:
    - Accepts a partial object with dot-path keys or nested partial (design choice for implementer)
    - Rejects any attempt to modify locked fields (`LOCKED_FIELDS` constant: `credentials`, `regionId`, `workspaceId`, `resourceId`, `projectPrefix`, `codeSource.codeSourceId`, `caller`, `version`)
    - Validates the updated settings via `SettingsSchema.parse()` after applying changes
    - Persists to disk via existing `writeSettings()`
    - Returns the diff of what changed (old value → new value)
  - Provides `getProfiles()`, `setProfile(name, overrides)`, `applyProfile(name)`, `deleteProfile(name)`
  - Constructor takes initial `Settings` object (from `loadSettings()`)

  Update `src/config/schema.ts`:
  - Add `ProfileSchema` — validates profile structure (only modifiable fields allowed):
    ```typescript
    const ProfileSchema = z.object({
      jobSpecs: z.array(JobSpecSchema).optional(),
      jobType: z.string().min(1).optional(),
      mounts: z.array(MountSchema).optional(),
      maxRunningJobs: z.number().int().positive().optional(),
    });
    ```
  - Add `profiles` field to `SettingsSchema` as **optional** (critical for v0.3.0→v0.4.0 migration):
    ```typescript
    profiles: z.record(z.string(), ProfileSchema).optional(),
    ```
  - Validate profile names: alphanumeric + hyphens, no spaces, no reserved words ("default", "current")

  **Must NOT do**:
  - Do NOT build config history, undo, or rollback
  - Do NOT build generic Zod reflection engine
  - Do NOT recreate API clients on config change
  - Do NOT allow locked fields in profiles

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`
    - Reason: Core infrastructure class with validation logic, moderate complexity
  - **Skills**: []
    - No external library skills needed, pure TypeScript + Zod

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Parallel Group**: Wave 1 (sequential foundation)
  - **Blocks**: Tasks 2, 3, 4, 5, 6
  - **Blocked By**: None

  **References**:

  **Pattern References**:
  - `src/config/schema.ts` (entire file) — Current Zod schema definitions. Add ProfileSchema and profiles field here.
  - `src/config/writer.ts` (entire file) — `writeSettings()` function. ConfigStore.update() should call this for persistence.
  - `src/config/loader.ts` (entire file) — `loadSettings()` function. ConfigStore constructor receives its output.

  **API/Type References**:
  - `src/config/schema.ts:SettingsSchema` — Root schema. profiles field added here. MUST be `.optional()` for v0.3.0 migration.
  - `src/config/schema.ts:JobSpecSchema` — Currently `z.record(z.string(), z.unknown())`. Profile overrides for jobSpecs use this shape.
  - `src/config/schema.ts:MountSchema` — Mount validation schema. Profiles may override mounts.

  **WHY Each Reference Matters**:
  - `writer.ts` provides the file persistence mechanism — ConfigStore wraps it, not replaces it
  - `schema.ts` is where ALL type definitions live — profiles must be validated at the same level
  - `loader.ts` shows the loading pattern that ConfigStore's constructor will consume

  **Acceptance Criteria**:

  - [ ] `src/config/store.ts` exists with `ConfigStore` class exported
  - [ ] `src/config/schema.ts` has `ProfileSchema` and `profiles` optional field in `SettingsSchema`
  - [ ] ConfigStore.update() throws on locked field attempt (unit logic)
  - [ ] ConfigStore.update() validates via Zod before persisting
  - [ ] ConfigStore.applyProfile() merges profile overrides into current settings
  - [ ] Profile names validated (alphanumeric + hyphens)
  - [ ] `bun run typecheck` → PASS (exit 0)
  - [ ] `bun run check` → PASS (exit 0)

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: TypeScript compilation succeeds with ConfigStore
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. Assert: exit code 0, no errors
    Expected Result: All types resolve correctly
    Evidence: Terminal output captured

  Scenario: Biome check passes
    Tool: Bash
    Steps:
      1. bun run check
      2. Assert: exit code 0
    Expected Result: Code style conformant
    Evidence: Terminal output captured

  Scenario: v0.3.0 settings file loads without error (migration compat)
    Tool: Bash
    Steps:
      1. Ensure test settings file has no "profiles" field
      2. bun run src/index.ts doctor (uses loadSettings internally)
      3. Assert: no "profiles" validation error
    Expected Result: Backward compatible settings loading
    Evidence: Doctor output captured
  ```

  **Commit**: YES
  - Message: `feat(config): add ConfigStore class with mutable settings, locked field enforcement, and profile support`
  - Files: `src/config/store.ts`, `src/config/schema.ts`
  - Pre-commit: `bun run typecheck && bun run check`

---

- [x] 2. DI Refactor — Replace `settings: Settings` with `configStore: ConfigStore`

  **What to do**:

  Update `src/mcp/server.ts`:
  - Import ConfigStore
  - After `loadSettings()`, create `configStore = new ConfigStore(settings)`
  - Pass `configStore` to ALL tool registrations instead of `settings`
  - Keep `settings` reference for client creation (`createDLCClient`, `createSTSClient`) since those need raw credentials at startup and never change

  Update ALL 8 remaining tool files (after codesource deletion in Task 3, but we refactor all current tools here):
  - `src/mcp/tools/config.ts` — Change `settings: Settings` → `configStore: ConfigStore`, read via `configStore.get()`
  - `src/mcp/tools/whoami.ts` — Same pattern
  - `src/mcp/tools/job-list.ts` — Same pattern
  - `src/mcp/tools/job-get.ts` — Same pattern
  - `src/mcp/tools/job-submit.ts` — Same pattern (critical: reads jobDefaults, mounts which are mutable)
  - `src/mcp/tools/job-stop.ts` — Same pattern
  - `src/mcp/tools/job-logs.ts` — Same pattern
  - `src/mcp/tools/job-wait.ts` — Same pattern
  - `src/mcp/tools/codesource.ts` — Same pattern (will be deleted in Task 3 but refactor first for clean diff)

  In each tool handler, replace `settings.fieldName` with `configStore.get().fieldName` so that every tool invocation reads the current config state.

  **Must NOT do**:
  - Do NOT change any tool's functionality or behavior
  - Do NOT modify tool input schemas
  - Do NOT change tool output format
  - Do NOT recreate API clients — they're created once at startup from raw settings

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: Mechanical refactor — same change pattern across all files, no logic changes
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Parallel Group**: Wave 1 (sequential, after Task 1)
  - **Blocks**: Tasks 3, 4, 5, 6
  - **Blocked By**: Task 1

  **References**:

  **Pattern References**:
  - `src/mcp/server.ts:16-38` — Current server bootstrap. Shows all tool registrations and DI pattern.
  - `src/mcp/tools/job-submit.ts:76-79` — Example of current `registerJobSubmitTool(server, settings, dlcClient)` signature
  - `src/mcp/tools/config.ts:10` — Example of current `registerConfigTool(server, settings)` signature

  **API/Type References**:
  - `src/config/store.ts:ConfigStore` — The new class from Task 1. Use `configStore.get()` to access current settings.

  **WHY Each Reference Matters**:
  - `server.ts` is the central wiring point — all DI changes happen here
  - Existing tool signatures show the exact pattern to transform

  **Acceptance Criteria**:

  - [ ] All tool registration functions accept `configStore: ConfigStore` instead of `settings: Settings`
  - [ ] `server.ts` creates ConfigStore and passes to all tools
  - [ ] Raw `settings` only used for client creation (lines 19-22 of current server.ts)
  - [ ] No tool file imports `Settings` type directly for DI (may still import for type narrowing)
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS
  - [ ] Server starts without error: `bun run src/index.ts server` (verify process starts, then Ctrl+C)

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Server starts successfully after DI refactor
    Tool: Bash
    Steps:
      1. timeout 5 bun run src/index.ts server || true
      2. Assert: no "Error" or "Cannot find" in stderr
    Expected Result: Server initializes (blocks on stdio, exits on timeout — that's expected)
    Evidence: Terminal output captured

  Scenario: Typecheck passes with refactored signatures
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. Assert: exit code 0
    Expected Result: All ConfigStore types resolve
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `refactor(mcp): replace static Settings DI with mutable ConfigStore across all tools`
  - Files: `src/mcp/server.ts`, all `src/mcp/tools/*.ts` files
  - Pre-commit: `bun run typecheck && bun run check`

---

- [x] 3. Remove Codesource Tools + Deprecate codeCommit

  **What to do**:

  Delete `src/mcp/tools/codesource.ts` entirely.

  Update `src/mcp/server.ts`:
  - Remove import of `registerCodeSourceTools`
  - Remove the `registerCodeSourceTools(server, configStore)` call

  Update `src/mcp/tools/job-submit.ts`:
  - Change `codeCommit` parameter description to include deprecation notice:
    ```
    "[DEPRECATED — Aliyun API has known bugs with commit pinning. Use codeBranch instead. 
     The job will always use the latest commit on the specified branch.]
     Git commit hash to checkout. If specified, behavior is unreliable — 
     prefer pushing to branch and omitting this parameter."
    ```
  - Keep the parameter functional (do NOT remove it)
  - Update `codeBranch` description to emphasize it's the primary mechanism:
    ```
    "Git branch for code source. This is the primary way to control which code version runs.
     The job pulls the latest commit on this branch at start time.
     WARNING: Branch switching via Aliyun PAI API may occasionally be unreliable. 
     Always verify the actual branch/commit in job logs after submission."
    ```

  **Must NOT do**:
  - Do NOT remove `codeCommit` parameter (keep functional for backward compat)
  - Do NOT modify job submission logic

  **Recommended Agent Profile**:
  - **Category**: `quick`
    - Reason: File deletion + description text changes, very mechanical
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 4, 5, 6)
  - **Blocks**: Task 7
  - **Blocked By**: Task 2

  **References**:

  **Pattern References**:
  - `src/mcp/tools/codesource.ts` (entire file) — The file to delete. Currently only registers `pai_codesource_get`.
  - `src/mcp/server.ts:6,28` — Import and registration to remove.
  - `src/mcp/tools/job-submit.ts:16-39` — Current input schema with `codeCommit` and `codeBranch` descriptions.

  **WHY Each Reference Matters**:
  - `codesource.ts` must be verified as only containing `_get` (confirmed by Metis — no `_update` exists)
  - `server.ts` import/registration must be removed to avoid crash
  - `job-submit.ts` schema descriptions are the deprecation target

  **Acceptance Criteria**:

  - [ ] `src/mcp/tools/codesource.ts` deleted
  - [ ] `src/mcp/server.ts` has no codesource imports or registration
  - [ ] `pai_job_submit` still accepts `codeCommit` parameter (not removed)
  - [ ] `codeCommit` description contains "DEPRECATED" and "unreliable"
  - [ ] `codeBranch` description mentions "primary way" and "verify in logs"
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Codesource file deleted, server still starts
    Tool: Bash
    Steps:
      1. ls src/mcp/tools/codesource.ts → Assert: file not found
      2. timeout 5 bun run src/index.ts server || true
      3. Assert: no import error in output
    Expected Result: Server starts without codesource tool
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `feat(mcp): remove codesource tools (unreliable API), deprecate codeCommit in job-submit`
  - Files: `src/mcp/tools/codesource.ts` (deleted), `src/mcp/server.ts`, `src/mcp/tools/job-submit.ts`
  - Pre-commit: `bun run typecheck && bun run check`

---

- [x] 4. New Tools: pai_config_schema + pai_config_update

  **What to do**:

  Create `src/mcp/tools/config-schema.ts`:
  - Register `pai_config_schema` tool (no input params, readOnlyHint: true)
  - Returns a structured JSON describing ALL modifiable config fields with:
    - Field path (e.g., `jobDefaults.jobSpecs[0].resourceConfig.GPU`)
    - Type (string, number, array, etc.)
    - Description (human-readable explanation)
    - Constraints (min/max, enum values, etc.)
    - Current value (from ConfigStore)
    - Whether it's modifiable or locked
  - **MUST hardcode field descriptions** — `JobSpecSchema` is `z.record(z.string(), z.unknown())` with no introspectable structure
  - Group fields logically: Job Resources, Docker Image, Job Type, Mounts, Concurrency, Profiles

  Create `src/mcp/tools/config-update.ts`:
  - Register `pai_config_update` tool with `destructiveHint: true`
  - Input schema: accepts a record of field paths to new values
    ```typescript
    {
      updates: z.record(z.string(), z.unknown())
        .describe("Map of field paths to new values. Example: { 'jobDefaults.jobSpecs[0].resourceConfig.GPU': '8' }")
    }
    ```
  - Calls `configStore.update(updates)`
  - Returns the diff: `{ changed: { path: { from: oldValue, to: newValue } } }`
  - On locked field attempt: returns `isError: true` with clear message
  - On Zod validation failure: returns `isError: true` with validation details

  Register both in `src/mcp/server.ts`.

  **Must NOT do**:
  - Do NOT build generic Zod schema introspection — hardcode the known fields
  - Do NOT validate against remote Aliyun API
  - Do NOT include credential fields in schema output

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`
    - Reason: Non-trivial tool implementation with schema design and ConfigStore integration
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 3, 5, 6)
  - **Blocks**: Task 7
  - **Blocked By**: Task 2

  **References**:

  **Pattern References**:
  - `src/mcp/tools/config.ts` — Existing `pai_config` tool pattern. Follow same structure for new tools.
  - `src/mcp/tools/job-submit.ts:16-39` — Example of Zod input schema definition for tools.
  - `src/mcp/tools/job-submit.ts:81-97` — Tool registration with annotations pattern.

  **API/Type References**:
  - `src/config/store.ts:ConfigStore` — `configStore.get()` for current values, `configStore.update()` for mutations.
  - `src/config/schema.ts:JobSpecSchema` — Currently untyped `z.record`. Schema tool must describe known fields (image, type, podCount, resourceConfig.GPU/CPU/memory/sharedMemory) manually.
  - `src/config/schema.ts:MountSchema` — Typed mount fields (name, uri, mountPath, mountAccess, options, description).
  - `src/config/schema.ts:JobDefaultsSchema` — jobType, displayNamePrefix, jobSpecs, simple, allowedNodes.

  **WHY Each Reference Matters**:
  - `config.ts` shows the exact registration pattern to follow
  - `JobSpecSchema` being untyped is the KEY technical constraint — must hardcode descriptions
  - `MountSchema` IS typed, so mount field descriptions can be derived from it

  **Acceptance Criteria**:

  - [ ] `pai_config_schema` returns structured JSON with all modifiable fields described
  - [ ] Schema includes: field path, type, description, constraints, current value, modifiable flag
  - [ ] `pai_config_update` with valid field → returns diff with from/to values
  - [ ] `pai_config_update` with locked field → returns isError with "locked" message
  - [ ] `pai_config_update` with invalid value → returns isError with Zod validation details
  - [ ] Both tools registered in server.ts
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Typecheck and lint pass with new tools
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. bun run check
      3. Assert: both exit code 0
    Expected Result: New tools type-safe and style-conformant
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `feat(mcp): add pai_config_schema and pai_config_update tools for dynamic configuration`
  - Files: `src/mcp/tools/config-schema.ts`, `src/mcp/tools/config-update.ts`, `src/mcp/server.ts`
  - Pre-commit: `bun run typecheck && bun run check`

---

- [x] 5. Server Instructions + pai_help Tool

  **What to do**:

  Update `src/mcp/server.ts`:
  - Add `instructions` as **second argument** to McpServer constructor:
    ```typescript
    const server = new McpServer(
      { name: "aliyun-pai-mcp", version: "0.4.0" },
      {
        instructions: `
          You are connected to Aliyun PAI-DLC via this MCP server.

          WORKFLOW:
          1. Write/modify code locally, then git commit && git push
          2. Use pai_config_schema to understand available configuration
          3. Use pai_config_apply_profile or pai_config_update to set appropriate resources
             (e.g., "debug" profile for 1-GPU quick tests, "train" profile for full training)
          4. Call pai_job_submit with a name and command. Code is pulled from the configured branch automatically.
          5. Use pai_job_wait + pai_job_logs to monitor. Verify the correct branch/commit in early log output.
          6. If errors: fix code locally, push, resubmit. Iterate until success.

          RULES:
          - ALL cluster interaction MUST go through pai_* tools. No exceptions.
          - NEVER call Aliyun APIs directly via curl, SDK, or CLI.
          - NEVER read or search for credential files on the filesystem.
          - NEVER run commands to inspect environment variables for secrets.
          - Branch switching via Aliyun PAI may occasionally be unreliable. Always verify in logs.

          Use pai_help for detailed usage guide.
        `
      }
    );
    ```

  Create `src/mcp/tools/help.ts`:
  - Register `pai_help` tool (no input params, readOnlyHint: true)
  - Returns comprehensive static text covering:
    - Full recommended workflow (detailed version of instructions)
    - Tool catalog with brief descriptions of all 14 tools
    - Config profile usage guide (how to list/apply/create profiles)
    - Common scenarios: "debug a training script", "scale up for production", "switch branches"
    - Troubleshooting: "job stuck in Queuing", "wrong branch deployed", "out of quota"
    - Security rules (expanded version)
  - ALL content is static embedded strings — NO network calls

  Register `pai_help` in `server.ts`.

  **Must NOT do**:
  - Do NOT make pai_help fetch content from network
  - Do NOT make instructions too long (keep under ~1KB — detailed help goes in pai_help)
  - Do NOT register instructions as a separate MCP prompt

  **Recommended Agent Profile**:
  - **Category**: `writing`
    - Reason: Primarily text content creation (instructions, help text), minimal code logic
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 3, 4, 6)
  - **Blocks**: Task 7
  - **Blocked By**: Task 2

  **References**:

  **Pattern References**:
  - `src/mcp/tools/whoami.ts` — Simplest tool pattern (no input, returns text). Follow for pai_help.
  - `src/mcp/server.ts:24` — Current McpServer construction. Change to two-argument form.

  **Documentation References**:
  - `README.md` "Typical Agent Workflow" section — Current workflow description. Instructions should reflect the new v0.4.0 workflow.
  - `README.md` "MCP Tools" table — Tool catalog. pai_help should list all tools with brief descriptions.

  **External References**:
  - MCP SDK: `instructions` goes in `ServerOptions` (second arg), not `Implementation` (first arg). Verified by Metis via source grep.

  **WHY Each Reference Matters**:
  - `whoami.ts` is the simplest template for a no-input tool — helps shows minimal boilerplate
  - `server.ts:24` is the exact line to modify for instructions
  - README workflow section has the content basis for instructions/help text

  **Acceptance Criteria**:

  - [ ] McpServer created with `{ instructions: "..." }` in second argument
  - [ ] Instructions contain workflow steps, security rules, and pai_help reference
  - [ ] `pai_help` tool returns comprehensive static text (>500 chars)
  - [ ] `pai_help` tool makes zero network calls
  - [ ] `pai_help` text covers: workflow, tool catalog, profiles, scenarios, troubleshooting, security
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Typecheck and lint pass with instructions and help tool
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. bun run check
      3. Assert: both exit code 0
    Expected Result: All new code compiles and passes lint
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `feat(mcp): add server instructions with workflow paradigm and pai_help tool`
  - Files: `src/mcp/server.ts`, `src/mcp/tools/help.ts`
  - Pre-commit: `bun run typecheck && bun run check`

---

- [x] 6. Config Profile Tools

  **What to do**:

  Create `src/mcp/tools/config-profiles.ts`:
  - Register THREE tools in one file:

  **`pai_config_list_profiles`** (readOnlyHint: true):
  - No input params
  - Returns list of profile names with brief description of each profile's overrides
  - Returns empty array `[]` if no profiles defined (not an error)

  **`pai_config_apply_profile`** (destructiveHint: true):
  - Input: `{ name: z.string().min(1).describe("Profile name to apply") }`
  - Calls `configStore.applyProfile(name)`
  - Returns diff of what changed (same format as pai_config_update)
  - Error if profile doesn't exist

  **`pai_config_create_profile`** (destructiveHint: true):
  - Input:
    ```typescript
    {
      name: z.string().min(1).regex(/^[a-z0-9-]+$/)
        .describe("Profile name (lowercase alphanumeric + hyphens)"),
      overrides: z.record(z.string(), z.unknown())
        .describe("Config field overrides for this profile"),
      fromCurrent: z.boolean().optional()
        .describe("If true, snapshot current config as base, then apply overrides on top")
    }
    ```
  - Validates overrides contain only modifiable fields (no locked fields)
  - Validates overrides pass Zod schema
  - Persists profile to ConfigStore → settings.json
  - Returns the created profile

  Register all three in `server.ts`.

  **Must NOT do**:
  - Do NOT allow profile names with spaces or special chars (regex: `^[a-z0-9-]+$`)
  - Do NOT allow profiles to contain locked field overrides
  - Do NOT build profile import/export
  - Do NOT build profile diff/comparison tools

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`
    - Reason: Three tools with validation logic and ConfigStore integration
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 2 (with Tasks 3, 4, 5)
  - **Blocks**: Task 7
  - **Blocked By**: Task 2

  **References**:

  **Pattern References**:
  - `src/mcp/tools/codesource.ts` (before deletion) — Example of registering multiple tools in one file.
  - `src/mcp/tools/config-update.ts` (from Task 4) — Uses ConfigStore.update(), similar pattern for applyProfile().

  **API/Type References**:
  - `src/config/store.ts:ConfigStore` — `getProfiles()`, `setProfile()`, `applyProfile()`, `deleteProfile()` methods.
  - `src/config/schema.ts:ProfileSchema` — Validation schema for profile overrides.

  **WHY Each Reference Matters**:
  - `codesource.ts` shows the multi-tool-per-file pattern (register multiple in one export function)
  - ConfigStore profile methods are the backend — tools are thin wrappers

  **Acceptance Criteria**:

  - [ ] Three tools registered: `pai_config_list_profiles`, `pai_config_apply_profile`, `pai_config_create_profile`
  - [ ] List returns `[]` when no profiles exist (not error)
  - [ ] Apply with invalid profile name → isError with "not found"
  - [ ] Create validates: name format, no locked fields, Zod schema pass
  - [ ] Created profile persists to settings.json
  - [ ] Applied profile changes reflected in `pai_config` output
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Typecheck and lint pass with profile tools
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. bun run check
      3. Assert: both exit code 0
    Expected Result: Profile tools compile and pass lint
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `feat(mcp): add config profile tools (list, apply, create) for resource preset management`
  - Files: `src/mcp/tools/config-profiles.ts`, `src/mcp/server.ts`
  - Pre-commit: `bun run typecheck && bun run check`

---

- [ ] 7. Version Bump, Docs, AGENTS.md

  **What to do**:

  Version bump in exactly 3 locations:
  - `package.json` line 3: `"version": "0.3.0"` → `"0.4.0"`
  - `src/index.ts` line 7: `.version("0.3.0")` → `.version("0.4.0")`
  - `src/mcp/server.ts`: version in McpServer constructor → `"0.4.0"`

  Update `README.md`:
  - Update "MCP Tools" table: remove codesource tools, add 6 new tools
  - Update "Typical Agent Workflow" section with new v0.4.0 paradigm (code → push → profile → submit → logs → iterate)
  - Update "How job submission works" section — mention Config Profiles, remove codeCommit emphasis
  - Update "Settings Reference" — add profiles section
  - Add "Recommended OpenCode Configuration" section with permission template:
    ```json
    {
      "$schema": "https://opencode.ai/config.json",
      "permission": {
        "external_directory": { "*": "deny" },
        "pai_config_update": "ask",
        "pai_config_apply_profile": "ask",
        "pai_config_create_profile": "ask"
      }
    }
    ```

  Update `AGENTS.md`:
  - Update tool count and structure
  - Add ConfigStore to architecture description
  - Update "WHERE TO LOOK" table with new tools

  Update `src/mcp/tools/AGENTS.md`:
  - Update tool list: remove codesource, add 6 new tools
  - Update conventions with ConfigStore DI pattern

  **Must NOT do**:
  - Do NOT change any code logic in this task
  - Do NOT add new features

  **Recommended Agent Profile**:
  - **Category**: `writing`
    - Reason: Documentation updates and version string changes
  - **Skills**: []

  **Parallelization**:
  - **Can Run In Parallel**: NO
  - **Parallel Group**: Wave 3 (final)
  - **Blocks**: None (final task)
  - **Blocked By**: Tasks 3, 4, 5, 6

  **References**:

  **Pattern References**:
  - `README.md` — Current documentation to update
  - `AGENTS.md` — Project knowledge base to update
  - `src/mcp/tools/AGENTS.md` — Tools module knowledge base to update

  **WHY Each Reference Matters**:
  - README is the user-facing documentation — must reflect v0.4.0 capabilities
  - AGENTS.md files are the AI knowledge base — must be accurate for future development

  **Acceptance Criteria**:

  - [ ] Version "0.4.0" in exactly 3 files, verified by grep
  - [ ] README MCP Tools table lists all 14 tools
  - [ ] README includes "Recommended OpenCode Configuration" section
  - [ ] README workflow section reflects v0.4.0 paradigm
  - [ ] AGENTS.md reflects ConfigStore architecture
  - [ ] `src/mcp/tools/AGENTS.md` lists all 14 tools
  - [ ] `bun run typecheck` → PASS
  - [ ] `bun run check` → PASS

  **Agent-Executed QA Scenarios**:

  ```
  Scenario: Version consistency check
    Tool: Bash
    Steps:
      1. grep -c '"0.4.0"' package.json src/index.ts src/mcp/server.ts
      2. Assert: each file returns 1 match (3 total)
    Expected Result: Version consistent across all locations
    Evidence: grep output captured

  Scenario: Final build verification
    Tool: Bash
    Steps:
      1. bun run typecheck
      2. bun run check
      3. timeout 5 bun run src/index.ts server || true
      4. Assert: all pass, server starts
    Expected Result: Complete v0.4.0 builds and runs
    Evidence: Terminal output captured
  ```

  **Commit**: YES
  - Message: `chore: bump version to 0.4.0, update documentation for dynamic config and profiles`
  - Files: `package.json`, `src/index.ts`, `src/mcp/server.ts`, `README.md`, `AGENTS.md`, `src/mcp/tools/AGENTS.md`
  - Pre-commit: `bun run typecheck && bun run check`

---

## Commit Strategy

| After Task | Message | Key Files | Verification |
|------------|---------|-----------|--------------|
| 1 | `feat(config): add ConfigStore class with mutable settings, locked field enforcement, and profile support` | store.ts, schema.ts | typecheck + check |
| 2 | `refactor(mcp): replace static Settings DI with mutable ConfigStore across all tools` | server.ts, all tools/*.ts | typecheck + check + server starts |
| 3 | `feat(mcp): remove codesource tools (unreliable API), deprecate codeCommit in job-submit` | codesource.ts (del), server.ts, job-submit.ts | typecheck + check |
| 4 | `feat(mcp): add pai_config_schema and pai_config_update tools for dynamic configuration` | config-schema.ts, config-update.ts, server.ts | typecheck + check |
| 5 | `feat(mcp): add server instructions with workflow paradigm and pai_help tool` | server.ts, help.ts | typecheck + check |
| 6 | `feat(mcp): add config profile tools (list, apply, create) for resource preset management` | config-profiles.ts, server.ts | typecheck + check |
| 7 | `chore: bump version to 0.4.0, update documentation for dynamic config and profiles` | package.json, index.ts, server.ts, README.md, AGENTS.md | typecheck + check + version grep |

---

## Success Criteria

### Verification Commands
```bash
bun run typecheck           # Expected: exit 0
bun run check               # Expected: exit 0
grep -c '"0.4.0"' package.json src/index.ts src/mcp/server.ts  # Expected: 1, 1, 1
timeout 5 bun run src/index.ts server || true   # Expected: starts without error
```

### Final Checklist
- [ ] ConfigStore with locked field enforcement working
- [ ] 14 MCP tools registered (8 existing + 6 new)
- [ ] Agent can view config schema with descriptions and constraints
- [ ] Agent can update modifiable fields (persisted to file)
- [ ] Agent can list, apply, and create config profiles
- [ ] Server instructions contain workflow + security rules
- [ ] pai_help returns comprehensive static guide
- [ ] codeCommit deprecated (not removed) in job-submit
- [ ] codesource tools removed
- [ ] All version references say "0.4.0"
- [ ] README updated with new workflow and OpenCode permission guide
- [ ] AGENTS.md files updated
- [ ] No credentials in any tool output
- [ ] v0.3.0 settings files load without error (profiles optional)
